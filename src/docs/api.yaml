openapi: 3.0.3
info:
  title: Transport API
  description: |
    API complète pour système de transport urbain avec gestion des tickets, paiements Wave, 
    validation QR codes, suivi GPS temps réel, réservations et notifications.
    
    ## Fonctionnalités principales
    - **Authentification JWT** avec vérification email et rôles (client, chauffeur, admin)
    - **Gestion tickets** avec QR codes chiffrés (AES-256-GCM)
    - **Paiements Wave** avec webhook sécurisé + paiements espèces
    - **Suivi GPS temps réel** avec historique des trajets
    - **Réservations** avec statuts et notifications
    - **WebSockets** pour événements temps réel
    - **Système de notifications** complet
    - **Dashboard** pour chauffeurs et admins
    - **Récupération mot de passe** sécurisée
    
  version: 1.0.0
  contact:
    name: Transport API       #name de l'app
    email: api@transportcom   #email de l'app
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:3000
    description: Serveur de développement
  - url: https://api.transport.com    #domaine name de l'app
    description: Serveur de production

security:
  - BearerAuth: []

# ==========================================
# WEBSOCKETS
# ==========================================
x-websockets:
  description: |
    ## WebSockets pour événements temps réel
    
    ### Connexion
    ```javascript
    const socket = io('ws://localhost:3000', {
      auth: { token: 'your-jwt-token' }
    });
    ```
    
    ### Événements disponibles
    
    #### Tickets
    - `ticketCreated` - Nouveau ticket créé
    - `ticketValidated` - Ticket validé par chauffeur
    
    #### Paiements
    - `paymentSuccess` - Paiement effectué avec succès
    - `paymentFailed` - Échec du paiement
    
    #### Réservations
    - `reservationCreated` - Nouvelle réservation
    - `reservationAccepted` - Réservation acceptée
    - `reservationCancelled` - Réservation annulée
    
    #### GPS & Véhicules
    - `vehiclePosition` - Position GPS mise à jour
    - `vehicleApproaching` - Véhicule en approche
    - `destinationReached` - Destination atteinte
    
    #### Dashboard
    - `dashboard:update` - Mise à jour des statistiques
    - `dashboard:stats` - Nouvelles statistiques
    
    #### Notifications
    - `notification` - Nouvelle notification
    - `notification:read` - Notification marquée comme lue
    
    ### Exemple d'utilisation
    ```javascript
    // Écouter les événements
    socket.on('ticketCreated', (data) => {
      console.log('Nouveau ticket:', data);
    });
    
    socket.on('paymentSuccess', (data) => {
      console.log('Paiement réussi:', data);
    });
    
    socket.on('vehiclePosition', (data) => {
      console.log('Position véhicule:', data);
    });
    
    // Rejoindre une room spécifique
    socket.emit('join', 'chauffeur_room');
    socket.emit('join', 'admin_room');
    ```
paths:
  # ==========================================
  # AUTHENTIFICATION
  # ==========================================
  /api/auth/register/requestVerification:
    post:
      tags:
        - Authentification
      summary: Demander vérification email pour inscription
      description: Envoie un code de vérification à 6 chiffres par email
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nom
                - email
                - telephone
                - mot_de_passe
              properties:
                nom:
                  type: string
                  minLength: 2
                  example: "Diallo Franck"
                email:
                  type: string
                  format: email
                  example: "john@example.com"
                telephone:
                  type: string
                  example: "0"
                mot_de_passe:
                  type: string
                  minLength: 8
                  example: "motdepasse123"
      responses:
        '200':
          description: Code de vérification envoyé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/auth/register/verify:
    post:
      tags:
        - Authentification
      summary: Vérifier code et créer compte
      description: Valide le code reçu par email et crée le compte utilisateur
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - code
              properties:
                email:
                  type: string
                  format: email
                code:
                  type: string
                  pattern: "^[0-9]{6}$"
                  example: "123456"
      responses:
        '201':
          description: Compte créé avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/auth/login:
    post:
      tags:
        - Authentification
      summary: Connexion utilisateur
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - mot_de_passe
              properties:
                email:
                  type: string
                  format: email
                mot_de_passe:
                  type: string
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/password/forgot:
    post:
      tags:
        - Authentification
      summary: Demander réinitialisation mot de passe
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Lien de réinitialisation envoyé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'

  /api/auth/password/reset:
    post:
      tags:
        - Authentification
      summary: Réinitialiser mot de passe
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
                - mot_de_passe
                - confirm_mot_de_passe
              properties:
                token:
                  type: string
                  description: Token reçu par email
                mot_de_passe:
                  type: string
                  minLength: 8
                confirm_mot_de_passe:
                  type: string
                  minLength: 8
      responses:
        '200':
          description: Mot de passe réinitialisé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'

  # ==========================================
  # PROFIL UTILISATEUR
  # ==========================================
  /api/profil/me:
    get:
      tags:
        - Profil
      summary: Consulter son profil
      description: Retourne les informations du profil de l'utilisateur connecté (basé sur le JWT).
      responses:
        '200':
          description: Profil utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Utilisateur'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - Profil
      summary: Mettre à jour son profil
      description: Permet à l'utilisateur connecté de modifier ses informations personnelles.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nom:
                  type: string
                email:
                  type: string
                  format: email
                telephone:
                  type: string
                mot_de_passe:
                  type: string
                  description: "Optionnel — si l'utilisateur veut changer son mot de passe"
                  minLength: 8
      responses:
        '200':
          description: Profil mis à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Utilisateur'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

    delete:
      tags:
        - Profil
      summary: Supprimer son compte
      description: Supprime définitivement le compte utilisateur connecté.
      responses:
        '200':
          description: Compte supprimé avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ==========================================
  # TICKETS
  # ==========================================
  /api/tickets:
    get:
      tags:
        - Tickets
      summary: Récupère les tickets de l'utilisateur connecté
      description: Retourne la liste des tickets appartenant à l'utilisateur authentifié.
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Liste des tickets de l'utilisateur
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Tickets récupérés avec succès
                  tickets:
                    type: array
                    items:
                      $ref: '#/components/schemas/Ticket'
        '401':
          description: Utilisateur non authentifié
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Utilisateur non authentifié

  /api/tickets/create:
    post:
      tags:
        - Tickets
      summary: Créer un ticket
      description: Crée un ticket avec QR code chiffré
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - trajet_id
              properties:
                trajet_id:
                  type: integer
                  example: 1
      responses:
        '201':
          description: Ticket créé avec QR code
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  ticket:
                    $ref: '#/components/schemas/Ticket'
                  qr:
                    $ref: '#/components/schemas/QRCode'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/tickets/validate:
    post:
      tags:
        - Tickets
      summary: Valider un ticket
      description: Valide un ticket via son token QR
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - token
              properties:
                token:
                  type: string
                  description: Token QR chiffré
      responses:
        '200':
          description: Ticket validé
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  message:
                    type: string
                  ticket:
                    $ref: '#/components/schemas/Ticket'

  /api/tickets/{ticketId}:
    get:
      tags:
        - Tickets
      summary: Image QR code (PNG)
      description: Retourne l'image PNG du QR code
      parameters:
        - name: ticketId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Image PNG du QR code
          content:
            image/png:
              schema:
                type: string
                format: binary

  # ==========================================
  # PAIEMENTS
  # ==========================================
  /api/paiements:
    post:
      tags:
        - Paiements
      summary: Créer un paiement
      description: Traite un paiement via Wave API et valide le ticket
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ticket_id
                - montant
                - mobile
                - token
              properties:
                ticket_id:
                  type: integer
                  example: 123
                montant:
                  type: number
                  minimum: 200
                  maximum: 1000000
                  example: 1500
                mobile:
                  type: string
                  pattern: "^[+]?[0-9]{8,15}$"
                  example: "+2250102030405"
                token:
                  type: string
                  description: Token QR du ticket
                name:
                  type: string
                  example: "Diallo Franck"
                currency:
                  type: string
                  enum: [XOF, EUR, USD]
                  default: XOF
      responses:
        '201':
          description: Paiement effectué et ticket validé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaiementResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '502':
          description: Erreur service Wave
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Paiements
      summary: Liste des paiements
      description: Retourne tous les paiements (admin)
      responses:
        '200':
          description: Liste des paiements
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Paiement'

  /api/paiements/user/{userId}:
    get:
      tags:
        - Paiements
      summary: Paiements d'un utilisateur
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Paiements de l'utilisateur
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Paiement'

  /api/paiements/user/{userId}/last:
    get:
      tags:
        - Paiements
      summary: Dernier paiements d'un utilisateur
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Dernier paiements de l'utilisateur
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Paiement'

  /api/paiements/webhook/wave:
    post:
      tags:
        - Paiements
      summary: Webhook Wave
      description: Endpoint pour les notifications Wave
      security: []
      parameters:
        - name: Wave-Signature
          in: header
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook traité
          content:
            text/plain:
              schema:
                type: string
                example: "ok"

  # ==========================================
  # TRAJETS, LIGNES & VEHICULES
  # ==========================================
  /api/trajets:
    get:
      tags:
        - Trajets
      summary: Liste des trajets
      responses:
        '200':
          description: Liste des trajets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Trajet'

    post:
      tags:
        - Trajets
      summary: Créer un trajet
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ligne_id
                - vehicule_id
                - heure_depart
                - heure_arrivee
              properties:
                ligne_id:
                  type: integer
                vehicule_id:
                  type: integer
                heure_depart:
                  type: string
                  format: date-time
                heure_arrivee:
                  type: string
                  format: date-time
      responses:
        '201':
          description: Trajet créé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trajet'
    
  /api/trajets/{id}:
    get:
      tags:
        - Trajets
      summary: Détails d'un Trajet
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détails du trajet
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicule'

    put:
      tags:
        - Trajets
      summary: Mise à jour trajet
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ligne_id:
                  type: integer
                vehicule_id:
                  type: integer
                heure_depart:
                  type: string
                  format: date-time
                heure_arrivee:
                  type: string
                  format: date-time
      responses:
        '200':
          description: Trajet mis à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trajet'

    delete:
      tags:
        - Trajets
      summary: Supprimer un trajet
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Trajet supprimé

  /api/lignes:
    get:
      tags:
        - Lignes
      summary: Liste des lignes
      responses:
        '200':
          description: Liste des lignes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Ligne'

    post:
      tags:
        - Lignes
      summary: Créer une Ligne
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - nom
                - arrets
              properties:
                nom:
                  type: string
                arrets:
                  type: array
                  items:
                    type: string
                  example: ["Sopim", "Fondation FHB", "Mofaitai", "Grand Marché", "Quartier 22", "INP-HB Nord"]
      responses:
        '201':
          description: Ligne créé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Trajet'

  /api/lignes/{id}:
    get:
      tags:
        - Ligne
      summary: Détails d'une Ligne
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détails de la ligne
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicule'

    put:
      tags:
        - Lignes
      summary: Mise à jour ligne
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nom:
                  type: string
                arrets:
                  type: array
                  items:
                    type: object
      responses:
        '200':
          description: Ligne mise à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ligne'

    delete:
      tags:
        - Lignes
      summary: Supprimer une ligne
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Ligne supprimée

  /api/vehicules:
    get:
      tags:
        - Véhicules
      summary: Liste des véhicules
      responses:
        '200':
          description: Liste des véhicules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Vehicule'

    post:
      tags:
        - Véhicules
      summary: Créer un véhicule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - immatriculation
                - type
                - statut_gps
              properties:
                immatriculation:
                  type: string
                  example: "ABCD12EF"
                type:
                  type: string
                  example: "Bus"
                statut_gps:
                  type: boolean
      responses:
        '201':
          description: Véhicule créé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicule'

  /api/vehicules/{id}:
    get:
      tags:
        - Véhicules
      summary: Détails d'un véhicule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détails du véhicule
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicule'

    put:
      tags:
        - Véhicules
      summary: Mettre à jour un véhicule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                immatriculation:
                  type: string
                type:
                  type: string
                statut_gps:
                  type: boolean
      responses:
        '200':
          description: Véhicule mis à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicule'

    delete:
      tags:
        - Véhicules
      summary: Supprimer un véhicule
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Véhicule supprimé

  # ==========================================
  # DASHBOARD
  # ==========================================
  /api/dashboard/overview:
    get:
      tags:
        - Dashboard
      summary: Vue d'ensemble
      description: Retourne les KPIs (utilisateurs, tickets, revenus…)
      responses:
        '200':
          description: Statistiques globales
          content:
            application/json:
              schema:
                type: object
                properties:
                  Total_utilisateur:
                    type: integer
                  utilisateurs_journalier:
                    type: integer
                  tickets_journalier:
                    type: integer
                  tickets_mensuel:
                    type: integer
                  revenues_journalier:
                    type: number
                  vehicule_en_ligne:
                    type: integer

  /api/dashboard/ticketsParTrajets:
    get:
      tags:
        - Dashboard
      summary: Tickets par trajet
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            example: 10
      responses:
        '200':
          description: Nombre de tickets par trajet
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    ligne_id:
                      type: integer
                    nombre_tickets:
                      type: integer

  /api/dashboard/paymentSummary:
    get:
      tags:
        - Dashboard
      summary: Résumé des paiements
      parameters:
        - name: from
          in: query
          schema:
            type: string
            format: date
        - name: to
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Résumé des paiements par jour
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    jour:
                      type: string
                      format: date
                    total:
                      type: number
                    nombre:
                      type: integer

  /api/dashboard/recentActivities:
    get:
      tags:
        - Dashboard
      summary: Activités récentes
      description: Timeline des tickets créés et paiements
      responses:
        '200':
          description: Liste des dernières activités
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                      enum: [ticket, paiement]
                    id:
                      type: integer
                    createdAt:
                      type: string
                      format: date-time

  # ==========================================
  # RÉSERVATIONS
  # ==========================================
  /api/reservations:
    post:
      tags:
        - Réservations
      summary: Créer une réservation
      description: Permet à un client de créer une réservation pour un trajet
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - trajet_id
                - vehicule_id
                - arret_depart
                - arret_arrivee
              properties:
                trajet_id:
                  type: integer
                  example: 1
                vehicule_id:
                  type: integer
                  example: 1
                arret_depart:
                  type: string
                  example: "Sopim"
                arret_arrivee:
                  type: string
                  example: "INP-HB Nord"
      responses:
        '201':
          description: Réservation créée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reservation'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/reservations/mes-reservations:
    get:
      tags:
        - Réservations
      summary: Mes réservations
      description: Récupère les réservations de l'utilisateur connecté
      responses:
        '200':
          description: Liste des réservations
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  reservations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Reservation'

  /api/reservations/chauffeur:
    get:
      tags:
        - Réservations
      summary: Réservations chauffeur
      description: Récupère les réservations pour un chauffeur
      responses:
        '200':
          description: Liste des réservations du chauffeur
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  reservations:
                    type: array
                    items:
                      $ref: '#/components/schemas/Reservation'

  /api/reservations/{id}/status:
    put:
      tags:
        - Réservations
      summary: Mettre à jour le statut d'une réservation
      description: Permet de changer le statut d'une réservation
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - statut
              properties:
                statut:
                  type: string
                  enum: [en_attente, acceptee, en_cours, terminee, annulee]
      responses:
        '200':
          description: Statut mis à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reservation'

  # ==========================================
  # NOTIFICATIONS
  # ==========================================
  /api/notifications:
    get:
      tags:
        - Notifications
      summary: Mes notifications
      description: Récupère les notifications de l'utilisateur connecté
      responses:
        '200':
          description: Liste des notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  notifications:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notification'

  /api/notifications/read:
    post:
      tags:
        - Notifications
      summary: Marquer comme lu
      description: Marque une notification comme lue
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - notification_id
              properties:
                notification_id:
                  type: integer
      responses:
        '200':
          description: Notification marquée comme lue
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'

  /api/notifications/all:
    delete:
      tags:
        - Notifications
      summary: Supprimer toutes les notifications
      description: Supprime toutes les notifications de l'utilisateur
      responses:
        '200':
          description: Toutes les notifications supprimées
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'

  /api/notifications/count:
    get:
      tags:
        - Notifications
      summary: Compteur de notifications non lues
      description: Retourne le nombre de notifications non lues
      responses:
        '200':
          description: Compteur de notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                    example: 5

  # ==========================================
  # CHAUFFEUR-VÉHICULES
  # ==========================================
  /api/chauffeur-vehicules/mes-vehicules:
    get:
      tags:
        - Chauffeur-Véhicules
      summary: Mes véhicules assignés
      description: Récupère les véhicules assignés au chauffeur connecté
      responses:
        '200':
          description: Liste des véhicules assignés
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  vehicules:
                    type: array
                    items:
                      $ref: '#/components/schemas/Vehicule'

  /api/chauffeur-vehicules/{vehiculeId}/gps:
    put:
      tags:
        - Chauffeur-Véhicules
      summary: Mettre à jour le statut GPS
      description: Active/désactive le GPS d'un véhicule
      parameters:
        - name: vehiculeId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - statut_gps
              properties:
                statut_gps:
                  type: boolean
      responses:
        '200':
          description: Statut GPS mis à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Vehicule'

  /api/chauffeur-vehicules/{vehiculeId}/trajets:
    get:
      tags:
        - Chauffeur-Véhicules
      summary: Trajets du jour
      description: Récupère les trajets du jour pour un véhicule
      parameters:
        - name: vehiculeId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Liste des trajets du jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  trajets:
                    type: array
                    items:
                      $ref: '#/components/schemas/Trajet'

  /api/chauffeur-vehicules/{vehiculeId}/position:
    post:
      tags:
        - Chauffeur-Véhicules
      summary: Envoyer position GPS
      description: Envoie la position GPS actuelle du véhicule
      parameters:
        - name: vehiculeId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - latitude
                - longitude
              properties:
                latitude:
                  type: number
                  format: float
                  example: 14.6928
                longitude:
                  type: number
                  format: float
                  example: -17.4467
      responses:
        '201':
          description: Position enregistrée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionGPS'

  /api/chauffeur-vehicules/{vehiculeId}/historique-gps:
    get:
      tags:
        - Chauffeur-Véhicules
      summary: Historique GPS
      description: Récupère l'historique GPS d'un véhicule
      parameters:
        - name: vehiculeId
          in: path
          required: true
          schema:
            type: integer
        - name: start
          in: query
          schema:
            type: string
            format: date-time
        - name: end
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Historique GPS
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  positions:
                    type: array
                    items:
                      $ref: '#/components/schemas/PositionGPS'

  # ==========================================
  # POSITIONS GPS
  # ==========================================
  /api/positions:
    post:
      tags:
        - Positions GPS
      summary: Envoyer position GPS
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - vehicule_id
                - latitude
                - longitude
              properties:
                vehicule_id:
                  type: integer
                latitude:
                  type: number
                  format: float
                  example: 14.6928
                longitude:
                  type: number
                  format: float
                  example: -17.4467
      responses:
        '201':
          description: Position enregistrée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionGPS'
  
  /api/positions/last/{vehiculeId}:
    get:
      tags:
        - Positions GPS
      summary: Dernière position d'un véhicule
      parameters:
        - name: vehiculeId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Dernière position connue
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PositionGPS'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/positions/route/{vehiculeId}:
    get:
      tags:
        - Positions GPS
      summary: Trace/route d'un véhicule
      description: Retourne des points ordonnés du plus ancien au plus récent. pour tracer un vehicule
      parameters:
        - name: vehiculeId
          in: path
          required: true
          schema:
            type: integer
        - name: start
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Filtrer à partir de cette date/heure (ISO 8601)
        - name: end
          in: query
          required: false
          schema:
            type: string
            format: date-time
          description: Filtrer jusqu'à cette date/heure (ISO 8601)
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1000
          description: Nombre maximum de points retournés
      responses:
        '200':
          description: Points de la route
          content:
            application/json:
              schema:
                type: object
                properties:
                  points:
                    type: array
                    items:
                      $ref: '#/components/schemas/PositionGPS'
        '400':
          $ref: '#/components/responses/BadRequest'

# ==========================================
# COMPONENTS
# ==========================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Authentification
    AuthResponse:
      type: object
      properties:
        message:
          type: string
        Utilisateur:
          $ref: '#/components/schemas/Utilisateur'
        token:
          type: string
          description: JWT token

    Utilisateur:
      type: object
      properties:
        id:
          type: integer
        nom:
          type: string
        email:
          type: string
          format: email
        telephone:
          type: string
        date_inscription:
          type: string
          format: date-time

    # Tickets
    Ticket:
      type: object
      properties:
        id:
          type: integer
        code_qr:
          type: string
        date_creation:
          type: string
          format: date-time
        date_expiration:
          type: string
          format: date-time
        statut_validation:
          type: boolean
        statut_expiration:
          type: boolean
        utilisateur_id:
          type: integer
        trajet_id:
          type: integer

    QRCode:     # donnée redis
      type: object
      properties:
        qr_id:
          type: string
          format: uuid
        token:
          type: string
          description: Token chiffré
        qr_png_base64:
          type: string
          description: Image QR en base64

    # Paiements
    Paiement:
      type: object
      properties:
        id:
          type: integer
        montant:
          type: number
          format: decimal
        date:
          type: string
          format: date-time
        methode:
          type: string
          example: "WAVE"
        transaction_id:
          type: string
        ticket_id:
          type: integer
        utilisateur_id:
          type: integer

    PaiementResponse:
      type: object
      properties:
        message:
          type: string
        paiement:
          $ref: '#/components/schemas/Paiement'
        payout:
          type: object
          properties:
            id:
              type: string
            status:
              type: string
            client_reference:
              type: string
        validation:
          type: object
          properties:
            valid:
              type: boolean
            validated_at:
              type: string
              format: date-time

    # Transport
    Trajet:
      type: object
      properties:
        id:
          type: integer
        ligne_id:
          type: integer
        vehicule_id:
          type: integer
        heure_depart:
          type: string
          format: date-time
        heure_arrivee:
          type: string
          format: date-time

    Ligne:
      type: object
      properties:
        id:
          type: integer
        nom:
          type: string
        arrets:
          type: array
          items:
            type: object

    Vehicule:
      type: object
      properties:
        id:
          type: integer
        immatriculation:
          type: string
        type:
          type: string
        statut_gps:
          type: boolean

    PositionGPS:
      type: object
      properties:
        id:
          type: integer
        latitude:
          type: number
          format: float
        longitude:
          type: number
          format: float
        timestamp:
          type: string
          format: date-time
        vehicule_id:
          type: integer

    # Réservations
    Reservation:
      type: object
      properties:
        id:
          type: integer
        utilisateur_id:
          type: integer
        trajet_id:
          type: integer
        vehicule_id:
          type: integer
        arret_depart:
          type: string
        arret_arrivee:
          type: string
        statut:
          type: string
          enum: [en_attente, acceptee, en_cours, terminee, annulee]
        ticket_id:
          type: integer
        date_reservation:
          type: string
          format: date-time
        date_prise_en_charge:
          type: string
          format: date-time

    # Notifications
    Notification:
      type: object
      properties:
        id:
          type: integer
        utilisateur_id:
          type: integer
        type:
          type: string
          enum: [ticket_created, ticket_validated, payment_success, reservation_accepted, vehicle_approaching, destination_reached]
        titre:
          type: string
        message:
          type: string
        lu:
          type: boolean
        date_creation:
          type: string
          format: date-time

    # Chauffeur-Véhicule
    ChauffeurVehicule:
      type: object
      properties:
        chauffeur_id:
          type: integer
        vehicule_id:
          type: integer
        actif:
          type: boolean
        date_assignation:
          type: string
          format: date-time
        date_desassignation:
          type: string
          format: date-time

    # Erreurs
    Error:
      type: object
      properties:
        message:
          type: string
        detail:
          type: string

    SuccessMessage:
      type: object
      properties:
        message:
          type: string

  responses:
    BadRequest:
      description: Requête invalide
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Non autorisé
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Ressource non trouvée
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'